<!DOCTYPE html>
<html>
<head>
  <title>Checkout</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
  <style>
    .payment-badges img { height: 30px; margin-right: 10px; }
    .payment-fields { display: none; transition: all 0.3s ease; }
  </style>
  <script>
    // Toggle card/UPI fields
    function togglePaymentFields() {
      const method = document.getElementById("payment_method").value;
      document.getElementById("card-fields").style.display = method === "Card" ? "block" : "none";
      document.getElementById("upi-fields").style.display = method === "UPI" ? "block" : "none";
    }

    // Apply coupons and calculate totals dynamically
    function applyCoupons() {
      const input = document.getElementById("coupon").value.trim();
      const coupons = input.split(/[ ,]+/).map(c => c.toUpperCase());

      const subtotal = parseFloat(document.getElementById("subtotal").getAttribute("data-value"));
      let deliveryFee = parseFloat(document.getElementById("delivery-row").getAttribute("data-value"));
      let discount = 0;

      coupons.forEach(c => {
        if (c === "WELCOME10") discount += 0.10 * subtotal;
        else if (c === "SAVE50") discount += 50;
        else if (c === "FREESHIP") deliveryFee = 0;
      });

      const finalTotal = Math.max(subtotal + deliveryFee - discount, 0);

      // Update UI
      document.getElementById("delivery-row").querySelector("span").innerText = `₹${deliveryFee.toFixed(2)}`;
      document.getElementById("discount-row").style.display = discount > 0 ? "flex" : "none";
      document.getElementById("discount-amount").innerText = discount > 0 ? `-₹${discount.toFixed(2)}` : "";
      document.getElementById("order-total").innerText = `₹${finalTotal.toFixed(2)}`;
    }

    window.onload = () => {
      togglePaymentFields();
      document.getElementById("coupon").addEventListener("input", applyCoupons);
    }
  </script>
</head>
<body>
  <div class="container mt-5">
    <h2>Checkout</h2>

    <form method="POST" action="{{ url_for('place_order') }}">
      <!-- Customer Info -->
      <div class="form-group">
        <label>Full Name:</label>
        <input type="text" name="name" class="form-control" required>
      </div>

      <div class="form-group">
        <label>Address:</label>
        <textarea name="address" class="form-control" required></textarea>
      </div>

      <!-- Payment Method -->
      <div class="form-group">
        <label>Payment Method:</label>
        <select name="payment_method" id="payment_method" class="form-control" required onchange="togglePaymentFields()">
          <option value="Cash on Delivery">Cash on Delivery</option>
          <option value="UPI">UPI</option>
          <option value="Card">Card</option>
        </select>
      </div>

      <!-- Card Fields -->
      <div id="card-fields" class="payment-fields">
        <div class="form-group">
          <label>Card Number:</label>
          <input type="text" name="card_number" class="form-control">
        </div>
        <div class="form-group">
          <label>Expiry Date:</label>
          <input type="month" name="expiry" class="form-control">
        </div>
        <div class="form-group">
          <label>CVV:</label>
          <input type="password" name="cvv" class="form-control">
        </div>
      </div>

      <!-- UPI Fields -->
      <div id="upi-fields" class="payment-fields">
        <div class="form-group">
          <label>UPI ID:</label>
          <input type="text" name="upi_id" class="form-control">
        </div>
      </div>

      <!-- Payment Badges -->
      <div class="payment-badges mb-3">
        <span>We accept:</span><br>
        <img src="https://img.icons8.com/color/48/visa.png" alt="Visa"/>
        <img src="https://img.icons8.com/color/48/mastercard-logo.png" alt="MasterCard"/>
        <img src="https://img.icons8.com/color/48/upi-logo.png" alt="UPI"/>
        <img src="https://img.icons8.com/color/48/paytm.png" alt="Paytm"/>
      </div>

      <!-- Coupon Code -->
      <div class="form-group">
        <label>Coupon Code (multiple allowed):</label>
        <input type="text" name="coupon" id="coupon" class="form-control" placeholder="e.g., WELCOME10 FREESHIP">
      </div>

      <!-- Order Summary -->
      <h5 class="mt-4">Order Summary:</h5>
      <ul class="list-group">
        {% for item in cart %}
        <li class="list-group-item d-flex justify-content-between">
          {{ item.name }} x{{ item.quantity }}
          <span>₹{{ item.quantity|int * item.price|float }}</span>
        </li>
        {% endfor %}
        <li class="list-group-item d-flex justify-content-between">
          Subtotal 
          <span id="subtotal" data-value="{{ subtotal }}">₹{{ "%.2f"|format(subtotal) }}</span>
        </li>
        <li id="delivery-row" class="list-group-item d-flex justify-content-between" data-value="{{ delivery_fee }}">
          Delivery Fee <span>₹{{ "%.2f"|format(delivery_fee) }}</span>
        </li>
        <li id="discount-row" class="list-group-item d-flex justify-content-between text-success" style="display:none;">
          Discount <span id="discount-amount"></span>
        </li>
        <li class="list-group-item d-flex justify-content-between font-weight-bold">
          Total <span id="order-total">₹{{ "%.2f"|format(total) }}</span>
        </li>
      </ul>

      <button type="submit" class="btn btn-success mt-3">Place Order</button>
    </form>
  </div>
</body>
</html>
