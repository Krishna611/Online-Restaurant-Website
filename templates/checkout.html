<!DOCTYPE html>
<html>
<head>
  <title>Checkout</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
  <style>
    .payment-badges img { height: 30px; margin-right: 10px; }
    .payment-fields { display: none; transition: all 0.3s ease; }
  </style>
  <script>
    function togglePaymentFields() {
      var method = document.getElementById("payment_method").value;

      var cardFields = document.getElementById("card-fields");
      var upiFields = document.getElementById("upi-fields");

      if (method === "Card") {
        cardFields.style.display = "block";
        upiFields.style.display = "none";
      } else if (method === "UPI") {
        cardFields.style.display = "none";
        upiFields.style.display = "block";
      } else {
        cardFields.style.display = "none";
        upiFields.style.display = "none";
      }
    }

    function applyCoupons() {
      let input = document.getElementById("coupon").value.trim();
      let coupons = input.split(/[ ,]+/).map(c => c.toUpperCase());

      let totalElement = document.getElementById("order-total");
      let discountElement = document.getElementById("discount-row");
      let deliveryElement = document.getElementById("delivery-row");

      let originalTotal = parseFloat(totalElement.getAttribute("data-original")); 
      let deliveryFee = parseFloat(deliveryElement.getAttribute("data-original")); 

      let bestDiscount = 0;
      let freeDelivery = false;

      coupons.forEach(coupon => {
        if (coupon === "DISCOUNT10") {
          bestDiscount = Math.max(bestDiscount, 0.10 * originalTotal);
        } else if (coupon === "WELCOME50") {
          bestDiscount = Math.max(bestDiscount, 50);
        } else if (coupon === "FREESHIP") {
          freeDelivery = true;
        }
      });

      let finalDelivery = freeDelivery ? 0 : deliveryFee;
      let newTotal = (originalTotal - bestDiscount) + finalDelivery;

      if (bestDiscount > 0) {
        discountElement.style.display = "flex";
        document.getElementById("discount-amount").innerText = "-₹" + bestDiscount.toFixed(2);
      } else {
        discountElement.style.display = "none";
      }

      deliveryElement.innerHTML = `Delivery Fee <span>₹${finalDelivery.toFixed(2)}</span>`;
      totalElement.innerText = "₹" + newTotal.toFixed(2);
    }

    window.onload = function() {
      togglePaymentFields(); // initialize correct fields
      document.getElementById("coupon").addEventListener("input", applyCoupons);
    }
  </script>
</head>
<body>
  <div class="container mt-5">
    <h2>Checkout</h2>

    <form method="POST" action="{{ url_for('place_order') }}">
      <!-- Customer Info -->
      <div class="form-group">
        <label>Full Name:</label>
        <input type="text" name="name" class="form-control" required>
      </div>

      <div class="form-group">
        <label>Address:</label>
        <textarea name="address" class="form-control" required></textarea>
      </div>

      <!-- Payment Method -->
      <div class="form-group">
        <label>Payment Method:</label>
        <select name="payment_method" id="payment_method" class="form-control" required onchange="togglePaymentFields()">
          <option value="Cash on Delivery">Cash on Delivery</option>
          <option value="UPI">UPI</option>
          <option value="Card">Card</option>
        </select>
      </div>

      <!-- Card Fields -->
      <div id="card-fields" class="payment-fields">
        <div class="form-group">
          <label>Card Number:</label>
          <input type="text" name="card_number" class="form-control">
        </div>
        <div class="form-group">
          <label>Expiry Date:</label>
          <input type="month" name="expiry" class="form-control">
        </div>
        <div class="form-group">
          <label>CVV:</label>
          <input type="password" name="cvv" class="form-control">
        </div>
      </div>

      <!-- UPI Fields -->
      <div id="upi-fields" class="payment-fields">
        <div class="form-group">
          <label>UPI ID:</label>
          <input type="text" name="upi_id" class="form-control">
        </div>
      </div>

      <!-- Payment Badges -->
      <div class="payment-badges mb-3">
        <span>We accept:</span><br>
        <img src="https://img.icons8.com/color/48/visa.png" alt="Visa"/>
        <img src="https://img.icons8.com/color/48/mastercard-logo.png" alt="MasterCard"/>
        <img src="https://img.icons8.com/color/48/upi-logo.png" alt="UPI"/>
        <img src="https://img.icons8.com/color/48/paytm.png" alt="Paytm"/>
      </div>

      <!-- Coupon Code -->
      <div class="form-group">
        <label>Coupon Code (you can enter multiple):</label>
        <input type="text" name="coupon" id="coupon" class="form-control" placeholder="e.g., DISCOUNT10 FREESHIP">
      </div>

      <!-- Order Summary -->
      <h5 class="mt-4">Order Summary:</h5>
      <ul class="list-group">
        {% for item in cart %}
        <li class="list-group-item d-flex justify-content-between">
          {{ item.name }} x{{ item.quantity }}
          <span>₹{{ item.quantity|int * item.price|int }}</span>
        </li>
        {% endfor %}
        <li id="discount-row" class="list-group-item d-flex justify-content-between text-success" style="display:none;">
          Discount
          <span id="discount-amount"></span>
        </li>
        <li id="delivery-row" class="list-group-item d-flex justify-content-between" data-original="40">
          Delivery Fee
          <span>₹40</span>
        </li>
        <li class="list-group-item d-flex justify-content-between font-weight-bold">
          Total
          <span id="order-total" data-original="{{ total }}">₹{{ total }}</span>
        </li>
      </ul>

      <button type="submit" class="btn btn-success mt-3">Place Order</button>
    </form>
  </div>
</body>
</html>
